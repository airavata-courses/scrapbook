{"version":3,"file":"ngxs-reset-plugin.js","sources":["../../../src/lib/internals.ts","../../../src/lib/reset.service.ts","../../../src/lib/reset.handler.ts","../../../src/lib/symbols.ts","../../../src/lib/reset.plugin.ts","../../../src/lib/reset.module.ts"],"sourcesContent":["export interface MetaDataModel {\n  name: string | null;\n  defaults: any;\n  path: string | null;\n  children?: StateClass[];\n}\n\n/**\n * a simplified implementation of NGXS StateClass interface\n */\nexport interface StateClass<T = {}> {\n  NGXS_META?: MetaDataModel;\n\n  new (...args: any[]): T;\n}\n\nexport function noop() {\n  return () => {};\n}\n","import { Injectable } from '@angular/core';\n\n@Injectable()\nexport class ResetService {\n  initialState: any;\n}\n","import { Injectable } from '@angular/core';\nimport { Actions, InitState, ofActionSuccessful, Store, UpdateState } from '@ngxs/store';\nimport { take } from 'rxjs/operators';\nimport { ResetService } from './reset.service';\n\n@Injectable()\nexport class ResetHandler {\n  constructor(\n    private actions$: Actions,\n    private store: Store,\n    private resetService: ResetService,\n  ) {\n    this.actions$\n      .pipe(\n        ofActionSuccessful(InitState),\n        take(1),\n      )\n      .subscribe(() => (this.resetService.initialState = this.store.snapshot()));\n\n    this.actions$.pipe(ofActionSuccessful(UpdateState)).subscribe(\n      ({ addedStates }) =>\n        (this.resetService.initialState = {\n          ...this.resetService.initialState,\n          ...addedStates,\n        }),\n    );\n  }\n}\n","import { isDevMode } from '@angular/core';\nimport { getStoreMetadata } from '@ngxs/store';\nimport { MetaDataModel, StateClass } from './internals';\n\nexport type OverwriteTuple = [StateClass, any];\ntype MetaTuple = [MetaDataModel[], any[]];\ntype MetaListReducer = (\n  acc: MetaDataModel[],\n  state: StateClass,\n) => MetaDataModel[];\ntype MetaTupleReducer = (\n  acc: MetaTuple,\n  [state, value]: OverwriteTuple,\n) => MetaTuple;\n\n/**\n * Action to clear all state except given state(s)\n */\nexport class StateClear {\n  static readonly type = '@@CLEAR_STATE';\n  public readonly statesToKeep: MetaDataModel[];\n\n  // The duplication is necessary for TypeScript\n  // tslint:disable-next-line:unified-signatures\n  constructor(...statesToKeep: StateClass[]);\n  constructor();\n  constructor(...statesToKeep: StateClass[]) {\n    const reducer = createMetaDataListReducer(isDevMode());\n    this.statesToKeep = statesToKeep.reduce<MetaDataModel[]>(reducer, []);\n  }\n}\n\n/**\n * Action to reset given state(s) to defaults\n */\nexport class StateReset {\n  static readonly type = '@@RESET_STATE';\n  public readonly statesToReset: MetaDataModel[];\n  constructor(...statesToReset: StateClass[]) {\n    const reducer = createMetaDataListReducer(isDevMode());\n    this.statesToReset = statesToReset.reduce<MetaDataModel[]>(reducer, []);\n  }\n}\n\n/**\n * Action to reset all states expect given state(s) to defaults\n */\nexport class StateResetAll {\n  static readonly type = '@@RESET_STATE_ALL';\n  public readonly statesToKeep: MetaDataModel[];\n\n  // The duplication is necessary for TypeScript\n  // tslint:disable-next-line:unified-signatures\n  constructor(...statesToKeep: StateClass[]);\n  constructor();\n  constructor(...statesToKeep: StateClass[]) {\n    const reducer = createMetaDataListReducer(isDevMode());\n    this.statesToKeep = statesToKeep.reduce<MetaDataModel[]>(reducer, []);\n  }\n}\n\n/**\n * Action to overwrite state(s) with given value(s)\n */\nexport class StateOverwrite {\n  static readonly type = '@@OVERWRITE_STATE';\n  public readonly statesToOverwrite: MetaDataModel[];\n  public readonly values: any[];\n  constructor(...overwriteConfigs: OverwriteTuple[]) {\n    const reducer = createMetaTupleReducer(isDevMode());\n    const [states, values] = overwriteConfigs.reduce<MetaTuple>(reducer, [\n      [],\n      [],\n    ]);\n\n    this.statesToOverwrite = states;\n    this.values = values;\n  }\n}\n\nexport function getMetaData(\n  state: StateClass,\n  devMode: number,\n): MetaDataModel | null {\n  const meta = new Object(getStoreMetadata(state as any)) as MetaDataModel;\n  const isNgxsMeta = meta.name && 'defaults' in meta;\n\n  // Reusability Hack: devMode is number on purpose\n  if (!isNgxsMeta && devMode === -2) {\n    console.warn(`Reset Plugin Warning: ${meta.name} is not a state class.`);\n    return null;\n  }\n\n  return meta;\n}\n\nfunction createMetaDataListReducer(devMode: boolean): MetaListReducer {\n  return (acc: MetaDataModel[], state: StateClass): MetaDataModel[] => {\n    // tslint:disable-next-line:no-bitwise\n    const meta = getMetaData(state, ~devMode);\n\n    return meta ? acc.concat(meta) : acc;\n  };\n}\n\nfunction createMetaTupleReducer(devMode: boolean): MetaTupleReducer {\n  return (acc: MetaTuple, [state, value]: OverwriteTuple): MetaTuple => {\n    // tslint:disable-next-line:no-bitwise\n    const meta = getMetaData(state, ~devMode);\n\n    return meta ? [acc[0].concat(meta), acc[1].concat(value)] : acc;\n  };\n}\n","import { Injectable } from '@angular/core';\nimport { getActionTypeFromInstance, getValue, NgxsPlugin, setValue } from '@ngxs/store';\nimport { MetaDataModel } from './internals';\nimport { ResetService } from './reset.service';\nimport {\n  getMetaData,\n  StateClear,\n  StateOverwrite,\n  StateReset,\n  StateResetAll,\n} from './symbols';\n\n@Injectable()\nexport class NgxsResetPlugin implements NgxsPlugin {\n  constructor(private readonly resetService: ResetService) {}\n\n  private clearStates(state: any, statesToKeep: MetaDataModel[]): any {\n    return statesToKeep\n      .map(meta => getPath(meta))\n      .map(path => ({\n        parts: path.split('.'),\n        value: getValue(state, path),\n      }))\n      .reduce(\n        (obj, { parts, value }) =>\n          parts.reduceRight(\n            (acc, part) =>\n              part in obj\n                ? {\n                    [part]: {\n                      ...obj[part],\n                      ...acc,\n                    },\n                  }\n                : { [part]: acc },\n            value,\n          ),\n        {} as any,\n      );\n  }\n\n  private overwriteStates(\n    state: any,\n    statesToOverwrite: MetaDataModel[],\n    values: any[],\n  ): any {\n    statesToOverwrite.forEach(\n      (meta, index) => (state = setValue(state, getPath(meta), values[index])),\n    );\n    return state;\n  }\n\n  private resetStates(state: any, statesToReset: MetaDataModel[]): any {\n    statesToReset.forEach(meta => {\n      state = setValue(\n        state,\n        getPath(meta),\n        typeof meta.defaults === 'undefined' ? {} : meta.defaults,\n      );\n\n      if (meta.children) {\n        state = this.resetStates(state, meta.children.map(\n          getMetaData,\n        ) as MetaDataModel[]);\n      }\n    });\n\n    return state;\n  }\n\n  private resetStatesAll(state: any, statesToKeep: MetaDataModel[]): any {\n    const values = statesToKeep.map(meta => getValue(state, getPath(meta)));\n\n    return this.overwriteStates(this.resetService.initialState, statesToKeep, values);\n  }\n\n  handle(state: any, action: any, next: any) {\n    const type = getActionTypeFromInstance(action);\n\n    switch (type) {\n      case StateClear.type:\n        state = this.clearStates(state, (action as StateClear).statesToKeep);\n        break;\n\n      case StateReset.type:\n        state = this.resetStates(state, (action as StateReset).statesToReset);\n        break;\n\n      case StateResetAll.type:\n        state = this.resetStatesAll(state, (action as StateResetAll).statesToKeep);\n        break;\n\n      case StateOverwrite.type:\n        const { statesToOverwrite, values } = action as StateOverwrite;\n        state = this.overwriteStates(state, statesToOverwrite, values);\n        break;\n\n      default:\n        break;\n    }\n\n    return next(state, action);\n  }\n}\n\nfunction getPath(meta: MetaDataModel): string {\n  return meta.path;\n}\n","import { APP_INITIALIZER, ModuleWithProviders, NgModule } from '@angular/core';\nimport { NGXS_PLUGINS } from '@ngxs/store';\nimport { noop } from './internals';\nimport { ResetHandler } from './reset.handler';\nimport { NgxsResetPlugin } from './reset.plugin';\nimport { ResetService } from './reset.service';\n\n@NgModule()\nexport class NgxsResetPluginModule {\n  static forRoot(): ModuleWithProviders<NgxsResetPluginModule> {\n    return {\n      ngModule: NgxsResetPluginModule,\n      providers: [\n        ResetService,\n        ResetHandler,\n        {\n          provide: APP_INITIALIZER,\n          useFactory: noop,\n          deps: [ResetHandler],\n          multi: true,\n        },\n        {\n          provide: NGXS_PLUGINS,\n          useClass: NgxsResetPlugin,\n          multi: true,\n        },\n      ],\n    };\n  }\n}\n"],"names":[],"mappings":"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"}