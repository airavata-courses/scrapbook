{"version":3,"file":"ngxs-storage-plugin.js","sources":["@ngxs/storage-plugin/src/symbols.ts","@ngxs/storage-plugin/src/internals.ts","@ngxs/storage-plugin/src/storage.plugin.ts","@ngxs/storage-plugin/src/storage.module.ts"],"names":[],"mappings":"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","sourcesContent":["import { InjectionToken } from '@angular/core';\r\n\r\nimport { StorageKey } from './internals';\r\n\r\nexport const enum StorageOption {\r\n  LocalStorage,\r\n  SessionStorage\r\n}\r\n\r\nexport interface NgxsStoragePluginOptions {\r\n  /**\r\n   * Key for the state slice to store in the storage engine.\r\n   */\r\n  key?: undefined | StorageKey;\r\n\r\n  /**\r\n   * Storage engine to use. Deaults to localStorage but can provide\r\n   *\r\n   * sessionStorage or custom implementation of the StorageEngine interface\r\n   */\r\n  storage?: StorageOption;\r\n\r\n  /**\r\n   * Migration strategies.\r\n   */\r\n  migrations?: {\r\n    /**\r\n     * Version to key off.\r\n     */\r\n    version: number | string;\r\n\r\n    /**\r\n     * Method to migrate the previous state.\r\n     */\r\n    migrate: (state: any) => any;\r\n\r\n    /**\r\n     * Key to migrate.\r\n     */\r\n    key?: string;\r\n\r\n    /**\r\n     * Key for the version. Defaults to 'version'.\r\n     */\r\n    versionKey?: string;\r\n  }[];\r\n\r\n  /**\r\n   * Serailizer for the object before its pushed into the engine.\r\n   */\r\n  serialize?(obj: any): string;\r\n\r\n  /**\r\n   * Deserializer for the object before its pulled out of the engine.\r\n   */\r\n  deserialize?(obj: any): any;\r\n\r\n  /**\r\n   * Method to alter object before serialization.\r\n   */\r\n  beforeSerialize?(obj: any, key: string): any;\r\n\r\n  /**\r\n   * Method to alter object after deserialization.\r\n   */\r\n  afterDeserialize?(obj: any, key: string): any;\r\n}\r\n\r\nexport const NGXS_STORAGE_PLUGIN_OPTIONS = new InjectionToken('NGXS_STORAGE_PLUGIN_OPTION');\r\n\r\nexport const STORAGE_ENGINE = new InjectionToken('STORAGE_ENGINE');\r\n\r\nexport interface StorageEngine {\r\n  readonly length: number;\r\n  getItem(key: string): any;\r\n  setItem(key: string, val: any): void;\r\n  removeItem(key: string): void;\r\n  clear(): void;\r\n}\r\n","import { isPlatformServer } from '@angular/common';\r\nimport { StateClass } from '@ngxs/store/internals';\r\nimport { StateToken } from '@ngxs/store';\r\n\r\nimport { StorageOption, StorageEngine, NgxsStoragePluginOptions } from './symbols';\r\n\r\n/**\r\n * If the `key` option is not provided then the below constant\r\n * will be used as a default key\r\n */\r\nexport const DEFAULT_STATE_KEY = '@@STATE';\r\n\r\n/**\r\n * Internal type definition for the `key` option provided\r\n * in the `forRoot` method when importing module\r\n */\r\nexport type StorageKey =\r\n  | string\r\n  | StateClass\r\n  | StateToken<any>\r\n  | (string | StateClass | StateToken<any>)[];\r\n\r\n/**\r\n * This key is used to retrieve static metadatas on state classes.\r\n * This constant is taken from the core codebase\r\n */\r\nconst META_OPTIONS_KEY = 'NGXS_OPTIONS_META';\r\n\r\nfunction transformKeyOption(key: StorageKey): string[] {\r\n  if (!Array.isArray(key)) {\r\n    key = [key];\r\n  }\r\n\r\n  return key.map((token: string | StateClass | StateToken<any>) => {\r\n    // If it has the `NGXS_OPTIONS_META` key then it means the developer\r\n    // has provided state class like `key: [AuthState]`.\r\n    if (token.hasOwnProperty(META_OPTIONS_KEY)) {\r\n      // The `name` property will be an actual state name or a `StateToken`.\r\n      token = (token as any)[META_OPTIONS_KEY].name;\r\n    }\r\n\r\n    return token instanceof StateToken ? token.getName() : (token as string);\r\n  });\r\n}\r\n\r\nexport function storageOptionsFactory(\r\n  options: NgxsStoragePluginOptions | undefined\r\n): NgxsStoragePluginOptions {\r\n  if (options !== undefined && options.key) {\r\n    options.key = transformKeyOption(options.key);\r\n  }\r\n\r\n  return {\r\n    key: [DEFAULT_STATE_KEY],\r\n    storage: StorageOption.LocalStorage,\r\n    serialize: JSON.stringify,\r\n    deserialize: JSON.parse,\r\n    beforeSerialize: obj => obj,\r\n    afterDeserialize: obj => obj,\r\n    ...options\r\n  };\r\n}\r\n\r\nexport function engineFactory(\r\n  options: NgxsStoragePluginOptions,\r\n  platformId: string\r\n): StorageEngine | null {\r\n  if (isPlatformServer(platformId)) {\r\n    return null;\r\n  }\r\n\r\n  if (options.storage === StorageOption.LocalStorage) {\r\n    return localStorage;\r\n  } else if (options.storage === StorageOption.SessionStorage) {\r\n    return sessionStorage;\r\n  }\r\n\r\n  return null;\r\n}\r\n","import { PLATFORM_ID, Inject, Injectable } from '@angular/core';\r\nimport { isPlatformServer } from '@angular/common';\r\nimport {\r\n  NgxsPlugin,\r\n  setValue,\r\n  getValue,\r\n  InitState,\r\n  UpdateState,\r\n  actionMatcher,\r\n  NgxsNextPluginFn\r\n} from '@ngxs/store';\r\nimport { tap } from 'rxjs/operators';\r\n\r\nimport {\r\n  StorageEngine,\r\n  NgxsStoragePluginOptions,\r\n  STORAGE_ENGINE,\r\n  NGXS_STORAGE_PLUGIN_OPTIONS\r\n} from './symbols';\r\nimport { DEFAULT_STATE_KEY } from './internals';\r\n\r\n@Injectable()\r\nexport class NgxsStoragePlugin implements NgxsPlugin {\r\n  constructor(\r\n    @Inject(NGXS_STORAGE_PLUGIN_OPTIONS) private _options: NgxsStoragePluginOptions,\r\n    @Inject(STORAGE_ENGINE) private _engine: StorageEngine,\r\n    @Inject(PLATFORM_ID) private _platformId: string\r\n  ) {}\r\n\r\n  handle(state: any, event: any, next: NgxsNextPluginFn) {\r\n    if (isPlatformServer(this._platformId) && this._engine === null) {\r\n      return next(state, event);\r\n    }\r\n\r\n    // We cast to `string[]` here as we're sure that this option has been\r\n    // transformed by the `storageOptionsFactory` function that provided token\r\n    const keys = this._options.key as string[];\r\n    const matches = actionMatcher(event);\r\n    const isInitAction = matches(InitState) || matches(UpdateState);\r\n    let hasMigration = false;\r\n\r\n    if (isInitAction) {\r\n      for (const key of keys) {\r\n        const isMaster = key === DEFAULT_STATE_KEY;\r\n        let val: any = this._engine.getItem(key!);\r\n\r\n        if (val !== 'undefined' && typeof val !== 'undefined' && val !== null) {\r\n          try {\r\n            const newVal = this._options.deserialize!(val);\r\n            val = this._options.afterDeserialize!(newVal, key);\r\n          } catch (e) {\r\n            console.error(\r\n              'Error ocurred while deserializing the store value, falling back to empty object.'\r\n            );\r\n            val = {};\r\n          }\r\n\r\n          if (this._options.migrations) {\r\n            this._options.migrations.forEach(strategy => {\r\n              const versionMatch =\r\n                strategy.version === getValue(val, strategy.versionKey || 'version');\r\n              const keyMatch = (!strategy.key && isMaster) || strategy.key === key;\r\n              if (versionMatch && keyMatch) {\r\n                val = strategy.migrate(val);\r\n                hasMigration = true;\r\n              }\r\n            });\r\n          }\r\n\r\n          if (!isMaster) {\r\n            state = setValue(state, key!, val);\r\n          } else {\r\n            state = { ...state, ...val };\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    return next(state, event).pipe(\r\n      tap(nextState => {\r\n        if (!isInitAction || (isInitAction && hasMigration)) {\r\n          for (const key of keys) {\r\n            let val = nextState;\r\n\r\n            if (key !== DEFAULT_STATE_KEY) {\r\n              val = getValue(nextState, key!);\r\n            }\r\n\r\n            try {\r\n              const newVal = this._options.beforeSerialize!(val, key);\r\n              this._engine.setItem(key!, this._options.serialize!(newVal));\r\n            } catch (e) {\r\n              console.error(\r\n                'Error ocurred while serializing the store value, value not updated.'\r\n              );\r\n            }\r\n          }\r\n        }\r\n      })\r\n    );\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders, PLATFORM_ID, InjectionToken } from '@angular/core';\r\nimport { NGXS_PLUGINS } from '@ngxs/store';\r\n\r\nimport {\r\n  NgxsStoragePluginOptions,\r\n  STORAGE_ENGINE,\r\n  NGXS_STORAGE_PLUGIN_OPTIONS\r\n} from './symbols';\r\nimport { NgxsStoragePlugin } from './storage.plugin';\r\nimport { storageOptionsFactory, engineFactory } from './internals';\r\n\r\nexport const USER_OPTIONS = new InjectionToken('USER_OPTIONS');\r\n\r\n@NgModule()\r\nexport class NgxsStoragePluginModule {\r\n  static forRoot(\r\n    options?: NgxsStoragePluginOptions\r\n  ): ModuleWithProviders<NgxsStoragePluginModule> {\r\n    return {\r\n      ngModule: NgxsStoragePluginModule,\r\n      providers: [\r\n        {\r\n          provide: NGXS_PLUGINS,\r\n          useClass: NgxsStoragePlugin,\r\n          multi: true\r\n        },\r\n        {\r\n          provide: USER_OPTIONS,\r\n          useValue: options\r\n        },\r\n        {\r\n          provide: NGXS_STORAGE_PLUGIN_OPTIONS,\r\n          useFactory: storageOptionsFactory,\r\n          deps: [USER_OPTIONS]\r\n        },\r\n        {\r\n          provide: STORAGE_ENGINE,\r\n          useFactory: engineFactory,\r\n          deps: [NGXS_STORAGE_PLUGIN_OPTIONS, PLATFORM_ID]\r\n        }\r\n      ]\r\n    };\r\n  }\r\n}\r\n"]}