node {
  def app
  def file = 'scrapbook-kafka'
  def masterIP = '149.165.171.246'
  def user = 'ubuntu'

  stage('Clone repository') {
    /* Checking out to the repository */
    checkout scm
  }

  stage('Prepare repository') {
    /* Copying the subdir to the parent */
    sh "cp -a ./${file}/. ."
    /* Removing sub directory */
    sh "rm -rf ./${file}"
  }

  stage('Deploy on Kubernetes'){
    /* SSH-ing to Kubernetes master and applying config */
    sshagent(["kube-ssh"]) {
      sh "scp scrapbook-zookeeper.yaml ${user}@${masterIP}:/home/${user}"
      sh "ssh ${user}@${masterIP} kubectl delete deployments --ignore-not-found=true zookeeper-deployment-1"
      sh "ssh ${user}@${masterIP} kubectl apply -f scrapbook-zookeeper.yaml"

      sh "scp scrapbook-broker.yaml ${user}@${masterIP}:/home/${user}"
      sh "ssh ${user}@${masterIP} kubectl delete deployments --ignore-not-found=true kafka-broker0"
      sh "ssh ${user}@${masterIP} kubectl apply -f scrapbook-broker.yaml"
    }
  }
}
